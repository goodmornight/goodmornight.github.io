<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0"><meta name="description" content="vue keycloak实现页面权限控制 [ GoodNight ] "><meta name="theme-color" content="#ebc65a"><title>vue keycloak实现页面权限控制 [ GoodNight ] </title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><script src="https://cdn.bootcss.com/highlight.js/9.6.0/highlight.min.js" defer></script><script src="/js/paper.js" defer></script><script src="https://www.googletagmanager.com/gtag/js?id=UA-171806323-1" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-171806323-1');</script><link rel="stylesheet" href="/css/tocbot.css"><script src="/js/tocbot.js" defer></script><script>window.addEventListener('DOMContentLoaded', () => {
  tocbot.init({
    // Where to render the table of contents.
    tocSelector: '.toc__content',
    // Where to grab the headings to build the table of contents.
    contentSelector: '.article__content',
    // Which headings to grab inside of the contentSelector element.
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    // For headings inside relative or absolute positioned containers within content.
    hasInnerContainers: true,
    orderedList: false,
    collapseDepth: 2,
  });
})</script><link rel="preload" href="https://cdn.bootcss.com/highlight.js/9.6.0/styles/github.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.6.0/styles/github.min.css"><link rel="preload" href="https://fonts.googleapis.com/css?family=Abril+Fatface&amp;display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface&amp;display=swap"><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="mask-border"></div><div class="head"><div class="head__inner"><h1><a href="/">GoodNight</a></h1><p>Take A Rest</p></div></div><div class="paper-container"><div class="main"><div class="location-bar"><div class="line-1"><div class="horizontal-line" style="height: 3px"></div></div><div class="line-2"><div class="horizontal-line" style="height: 1px"></div></div><p class="text">vue keycloak实现页面权限控制</p><div class="switch-button"><input class="container_toggle" type="checkbox" id="switch" name="mode"><label for="switch">Toggle</label></div><div class="line-3"><div class="horizontal-line" style="height: 1px"></div></div></div><div class="main__2-col"><article class="post-view__article"><div class="article__infomation"><div class="posts-item"><h2 class="posts-item__title"><a href="">vue keycloak实现页面权限控制</a></h2><span class="post__date">2020-07-18</span><a href="/tags/VUE/"><span class="post__tags">#VUE</span></a><a href="/tags/%E5%AF%92%E6%AD%A6%E7%BA%AA%E9%A1%B9%E7%9B%AE/"><span class="post__tags">#寒武纪项目</span></a><a href="/tags/keycloak/"><span class="post__tags">#keycloak</span></a></div></div><div class="article__content"><p>刚开始使用keycloak的时候，很多接口参数不知道，就感觉你访问任何页面都需要登录才可访问。但项目需要某些页面不需要用户登录也可以查看。我通过<a href="https://github.com/dsb-norge/vue-keycloak-js/issues/2" target="_blank" rel="noopener">Protected urls #2 | github issue</a>受到了启发。</p>
<p>keycloak中的<code>init.onLoad</code>可选两个参数<code>login-required</code>、<code>check-sso</code>。其中，<code>login-required</code>会检查你是否登录到了keycloak以及判断你登录的客户端是否正确，如果没有登录就跳转到keycloak的登录页面；<code>check-sso</code>只会判断你登录的客户端是否正确，如果没有登录就会保持未登录的状态。</p>
<p>所以<code>check-sso</code>是我所需要的。</p>
<p>我是使用vue开发的项目，用的插件是<a href="https://www.npmjs.com/package/@dsb-norge/vue-keycloak-js" target="_blank" rel="noopener">@dsb-norge/vue-keycloak-js | npm</a>。以下内容均是基于这个插件的。</p>
<h1 id="初始化设置"><a href="#初始化设置" class="headerlink" title="初始化设置"></a>初始化设置</h1><p>最开始的开始，当然是安装插件了，这块就不需要我多说了，建议用<strong>cnpm</strong>安装，这个比较快。</p>
<p>在<strong>main.js</strong>文件里，添加使用<strong>vue-keycloak-js</strong>代码。</p>
<p>用<strong>token</strong>不需要另外保存到<strong>localStorage</strong>了，只需要通过<strong>this.$keycloak.token</strong>获取即可。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> VueKeyCloak <span class="hljs-keyword">from</span> <span class="hljs-string">'@dsb-norge/vue-keycloak-js'</span><br>Vue.use(VueKeyCloak, &#123;<br>  init: &#123;<br>    onLoad: <span class="hljs-string">'check-sso'</span><br>  &#125;,<br>  config: &#123;<br>    url: process.env.VUE_APP_AUTH_URL, <span class="hljs-attr">realm</span>: process.env.VUE_APP_AUTH_REALM, <span class="hljs-attr">clientId</span>: process.env.VUE_APP_AUTH_CLIENT_ID,<br>  &#125;,<br>  onReady: <span class="hljs-function"><span class="hljs-params">kc</span> =&gt;</span> &#123;<br><br>    <span class="hljs-comment">// 判断用户是否登录，如果登录了就向数据库请求用户信息</span><br>    <span class="hljs-keyword">if</span>(kc.authenticated)&#123;<br>      <span class="hljs-comment">// 获取用户信息</span><br>      http.get(<span class="hljs-string">'_users/'</span> + kc.subject)<br>      .then(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> &#123;<br>        store.commit(<span class="hljs-string">'auth/SET_CURRENT_USER'</span>, response.data.data)<br>      &#125;)<br>      .catch(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>        <span class="hljs-built_in">console</span>.log(error)<br>      &#125;)<br>        <br>    &#125;<br>    <br>    <span class="hljs-keyword">new</span> Vue(&#123;<br>      router,<br>      store,<br>      created () &#123;<br>        <span class="hljs-comment">// 监听用户信息，用户信息改变则重新从数据库里请求用户信息</span><br>        <span class="hljs-keyword">this</span>.$watch(<span class="hljs-string">'$keycloak.userInfo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br><br>          <span class="hljs-keyword">if</span>(kc.authenticated)&#123;<br><br>            http.get(<span class="hljs-string">'_users/'</span> + kc.subject)<br>            .then(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> &#123;<br>              store.commit(<span class="hljs-string">'auth/SET_CURRENT_USER'</span>, response.data.data)<br>            &#125;)<br>            .catch(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>              <span class="hljs-built_in">console</span>.log(error)<br>            &#125;)<br>            <br>          &#125;<br><br>        &#125;, &#123; <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span> &#125;)<br><br>      &#125;,<br>      render: <span class="hljs-function"><span class="hljs-params">h</span> =&gt;</span> h(App)<br>    &#125;).$mount(<span class="hljs-string">'#app'</span>)<br>  &#125;<br>&#125;)<br></code></pre></td></tr></table></figure>

<h1 id="路由设置"><a href="#路由设置" class="headerlink" title="路由设置"></a>路由设置</h1><p>routes.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [<br>  &#123;<br>    path: <span class="hljs-string">'/'</span>,<br>    name: <span class="hljs-string">'main'</span>,<br>    component: Main<br>  &#125;,<br>  &#123;<br>    path: <span class="hljs-string">'/secured'</span>,<br>    name: <span class="hljs-string">'secured'</span>,<br>    component: Secured,<br>    meta: &#123;<br>      requiresAuth: <span class="hljs-literal">true</span><br>    &#125;<br>  &#125;<br>]<br></code></pre></td></tr></table></figure>

<p>router.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript">router.beforeEach(<span class="hljs-function">(<span class="hljs-params">routeTo, routeFrom, next</span>) =&gt;</span> &#123;<br><br>  <span class="hljs-comment">// 页面是否需要用户验证</span><br>  <span class="hljs-keyword">const</span> authRequired = routeTo.matched.some(<span class="hljs-function">(<span class="hljs-params">route</span>) =&gt;</span> route.meta.authRequired)<br><br>  <span class="hljs-comment">// 如果该页面不需要登陆验证，则直接进入</span><br>  <span class="hljs-keyword">if</span> (!authRequired) <span class="hljs-keyword">return</span> next()<br><br>  <span class="hljs-comment">// 如果该页面需要认证，则判断该用户是否已登录</span><br>  <span class="hljs-keyword">if</span> (Vue.prototype.$keycloak.authenticated) &#123;<br><br>    <span class="hljs-comment">// 判断用户是否有管理员权限，管理员进入页面不受限制</span><br>    <span class="hljs-keyword">if</span> (Vue.prototype.$keycloak.hasRealmRole(<span class="hljs-string">'C_ADMIN'</span>)) <span class="hljs-keyword">return</span> next()<br><br>    <span class="hljs-comment">// 用户为普通用户，判断是否有进入该页面的权限</span><br>    <span class="hljs-keyword">if</span> (userRoutes.some(<span class="hljs-function"><span class="hljs-params">route</span> =&gt;</span> route.path === routeTo.path)) <span class="hljs-keyword">return</span> next()<br><br>    <span class="hljs-comment">// 普通用户，无进入该页面权限，重定向可进入的页面</span><br>    next(&#123; <span class="hljs-attr">path</span>: userRoutes[<span class="hljs-number">0</span>].path &#125;)<br><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 未登录则进入登录界面</span><br>    <span class="hljs-keyword">const</span> loginUrl = Vue.prototype.$keycloak.createLoginUrl()<br>    <span class="hljs-built_in">window</span>.location.replace(loginUrl)<br><br>  &#125;<br><br>&#125;)<br></code></pre></td></tr></table></figure>

<h1 id="主页跳转问题"><a href="#主页跳转问题" class="headerlink" title="主页跳转问题"></a>主页跳转问题</h1><p>后来我发现这样设置，出现了一点点小问题。</p>
<p>如果你退出账户时，不在首页，则重新登录就直接跳转到你原来所在的页面。</p>
<p>这个问题看起来没有太大的毛病，但是如果是普通用户和管理员用户之间切换，那么管理员状态登录就无法直接进入主页。</p>
<p>这个问题我尝试了很多种方法：</p>
<ol>
<li>删除路由历史记录（其实这个不是问题的根本，所以这么做是无意义的，况且Vue Router不存在清空历史记录的函数和功能）</li>
<li>尝试从刚进入页面时进行全局路由设置，会导致next()循环</li>
<li>通过退出用户，设置跳转主页，可实现管理员下次系统进入主页，但无法实现普通用户切换管理员进入非主页问题</li>
</ol>
<p>最后的解决方法是，单独对每一个路由进行设置，如果是初次进入系统，进入页面如果不是主页就跳转到主页。以我的某个页面为例：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> containersRoutes = [<br>  &#123;<br>    path: <span class="hljs-string">'/containerList'</span>,<br>    name: <span class="hljs-string">'容器列表'</span>,<br>    icon: <span class="hljs-string">'box'</span>,<br>    component: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> lazyLoadView(<span class="hljs-keyword">import</span>(<span class="hljs-string">'@views/docker-hub/containerList'</span>)),<br>    meta: &#123;<br><br>      authRequired: <span class="hljs-literal">true</span>,<br>      beforeResolve(routeTo, routeFrom, next) &#123;<br><br>        <span class="hljs-comment">// 非初次进入系统</span><br>        <span class="hljs-keyword">if</span> (routeFrom.name !== <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> next()<br>        <span class="hljs-comment">// 初次进入系统，管理员进入主机页面，普通用户进入镜像列表</span><br>        <span class="hljs-keyword">if</span>(Vue.prototype.$keycloak.hasRealmRole(<span class="hljs-string">'C_ADMIN'</span>)) <span class="hljs-keyword">return</span> next(<span class="hljs-string">'/'</span>)<br>        <span class="hljs-keyword">return</span> next(<span class="hljs-string">'/imageList'</span>)<br><br>      &#125;,<br><br>    &#125;,<br>    props: <span class="hljs-function">(<span class="hljs-params">route</span>) =&gt;</span> (&#123; <span class="hljs-attr">user</span>: store.state.auth.currentUser || &#123;&#125; &#125;)<br>  &#125;<br>]<br></code></pre></td></tr></table></figure>





<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://www.jianshu.com/p/4ff7f0e491c3" target="_blank" rel="noopener">Vue集成Keycloak | 简书</a></p>
<p><a href="https://github.com/dsb-norge/vue-keycloak-js/issues/2" target="_blank" rel="noopener">Protected urls #2 | github issue</a></p>
<p><a href="https://www.npmjs.com/package/@dsb-norge/vue-keycloak-js" target="_blank" rel="noopener">@dsb-norge/vue-keycloak-js | npm</a></p>
<hr>
<p>写文不易，如需转载，请注明出处。</p>
<p>注意文章编写时间，一切以官方文档为主。</p>
<p>如果某处写的有问题，欢迎发邮件，一起交流讨论，共同进步。</p>
</div></article><div class="post-view__sidebar"><div class="sidebar"><div class="tocbot"><h2>Toc</h2><div class="toc__content"></div></div><h2>Links</h2><div class="sidebar__link"><ul><li><a href="https://github.com/GoodNight-Git" target="_blank" rel="noopener">Github</a></li><li><a href="https://juejin.im/user/5cb1ed9b5188251b090acc5c" target="_blank" rel="noopener">掘金</a></li><li><a href="mailto:goodnightlilanhui@gmail.com">Mail</a></li></ul></div><h2>Archives</h2><div class="sidebar__archives"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">2017</a></li></ul></div><h2>Categories</h2><div class="sidebar__categories"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/about/">about</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/notes/">notes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/plans/">plans</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/projects/">projects</a></li></ul></div><h2>Tags</h2><div class="sidebar__tags"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Axios/" rel="tag">Axios</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/" rel="tag">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Coding-net/" rel="tag">Coding.net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CodingThinking/" rel="tag">CodingThinking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Color/" rel="tag">Color</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/" rel="tag">ES6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Github/" rel="tag">Github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javascript/" rel="tag">Javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kali-2-0/" rel="tag">Kali 2.0</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Keycloak/" rel="tag">Keycloak</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/" rel="tag">Markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenCV/" rel="tag">OpenCV</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python-Web/" rel="tag">Python Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Qt/" rel="tag">Qt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL-Server/" rel="tag">SQL Server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Translation/" rel="tag">Translation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UI/" rel="tag">UI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu%E7%B3%BB%E7%BB%9F/" rel="tag">Ubuntu系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VUE/" rel="tag">VUE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Win10/" rel="tag">Win10</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/keycloak/" rel="tag">keycloak</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/" rel="tag">node</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/npm/" rel="tag">npm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/taro/" rel="tag">taro</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%A7%E5%93%81/" rel="tag">产品</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E6%8E%A8/" rel="tag">内推</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9B%BE%E5%BA%8A/" rel="tag">图床</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AF%92%E6%AD%A6%E7%BA%AA%E9%A1%B9%E7%9B%AE/" rel="tag">寒武纪项目</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BB%BA%E7%AB%99/" rel="tag">建站</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag">微信小程序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82%E9%A1%B9/" rel="tag">杂项</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A2%8E%E7%A2%8E%E5%BF%B5/" rel="tag">碎碎念</a></li></ul></div></div></div></div><div class="horizontal-line" style="height: 1px"></div><div class="main__bottom"><div class="pre-next"><a class="pre-button" href="/2020/07/20/React%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%BA%94%E7%94%A8/">React创建一个应用</a><a class="next-button" href="/2020/07/18/HSL-HSV-RGB/">HSL/HSV/RGB</a></div></div></div></div><div class="footer"><span>©️2019-2020 </span><p>Designed By&nbsp;<strong><a href="https://github.com/random-yang" target="_blank" rel="noopener">RandomYang</a></strong></p><p>Changed By<strong><a href="http://www.goodnight.wiki" target="_blank" rel="noopener">GoodNight</a></strong></p><p>Powered By&nbsp;<strong><a href="https://hexo.io" target="_blank" rel="noopener">hexo</a></strong></p><p><div id="beian"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=61019002001135" target="_blank" rel="noopener"><img src="../img/beian.png"><span>陕公网安备 61019002001135号&nbsp;</span></a></div><div id="tengxun"><a href="http://beian.miit.gov.cn" target="_blank" rel="noopener">陕ICP备20010639号</a></div></p></div><div class="darkmode-mask" id="darkmode-mask"></div><div class="sidebar__button"></div></body></html>